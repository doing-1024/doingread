<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title></title>
    <script src="https://lib.webstatic.cn/ajax/jquery/3.5.1/jquery.min.js"></script>
    <style>
      /* --- 保持原有样式不变 --- */
      .navbar {
        position: fixed;
        top: -60px;
        left: 0;
        right: 0;
        height: 60px;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        padding: 0 20px;
        transition: top 0.3s ease;
        z-index: 1000;
      }
      .navbar.show {
        top: 0;
      }
      .navbar a {
        color: #fff;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 4px;
        transition: background 0.2s;
      }
      .navbar a:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .controls-group {
        position: fixed;
        top: 20px;
        right: 20px;
        display: flex;
        gap: 10px;
        z-index: 1001;
      }
      .control-icon {
        width: 40px;
        height: 40px;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        cursor: pointer;
        backdrop-filter: blur(10px);
        transition: 0.3s;
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .control-icon:hover {
        background: rgba(0, 0, 0, 0.9);
        transform: scale(1.1);
      }
      .cursor {
        animation: blink 1s infinite;
      }
      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0;
        }
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
      }
      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        padding: 30px;
        border-radius: 12px;
        width: 320px;
        color: #fff;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
      }
      .form-group select,
      .form-group input {
        width: 100%;
        padding: 10px;
        background: #333;
        color: #fff;
        border: 1px solid #555;
        border-radius: 6px;
      }
      .form-buttons {
        display: flex;
        justify-content: flex-end;
        margin-top: 20px;
      }
      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        background: #95a5a6;
        color: white;
      }
      .progress-bar {
        position: fixed;
        bottom: -10px;
        left: 0;
        right: 0;
        height: 10px;
        background: rgba(255, 255, 255, 0.1);
        transition: bottom 0.3s ease;
        z-index: 1000;
        cursor: pointer;
      }
      .progress-bar.show {
        bottom: 0;
      }
      .progress-fill {
        height: 100%;
        background: #3498db;
        width: 0%;
        transition: width 0.1s linear;
      }
      @media (max-width: 768px) {
        .text {
          font-size: 28px !important;
        }
      }
    </style>
  </head>
  <body
    style="
      height: 100vh;
      background: #000;
      color: #fff;
      margin: 0;
      overflow: hidden;
    "
  >
    <nav class="navbar" id="navbar">
      <a href="/">← 返回首页</a>
      <span
        id="articleTitle"
        style="flex: 1; text-align: center; font-weight: 500"
      ></span>
    </nav>

    <div class="controls-group">
      <div class="control-icon" id="playPauseBtn" onclick="togglePlay()">⏸</div>
      <div class="control-icon" onclick="showSettings()">⚙️</div>
    </div>

    <div class="progress-bar" id="progressBar">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <div class="modal" id="settingsModal">
      <div class="modal-content">
        <h3>阅读器设置</h3>
        <div class="form-group">
          <label>阅读器样式</label>
          <select id="readerStyleSelect" onchange="changeReaderStyle()">
            <option value="breath">呼吸模式</option>
            <option value="typewriter">打字机模式</option>
          </select>
        </div>
        <div class="form-group">
          <label>字体大小: <span id="fontSizeValue">36px</span></label>
          <input
            type="range"
            id="fontSizeSlider"
            min="20"
            max="80"
            value="36"
            onchange="changeFontSize()"
          />
        </div>
        <div class="form-buttons">
          <button class="btn" onclick="hideSettings()">确定</button>
        </div>
      </div>
    </div>

    <div
      style="
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        padding: 0 40px;
      "
    >
      <p
        class="text"
        style="font-size: 36px; line-height: 1.6; max-width: 800px; margin: 0"
      ></p>
    </div>

    <script>
      $(document).ready(function () {
        let currentIndex = 0;
        let text_list = [];
        let isPlaying = true;
        let isDragging = false;
        let timers = [];
        let readerStyle = localStorage.getItem("readerStyle") || "breath";

        // --- 初始化数据 ---
        const articles = JSON.parse(localStorage.getItem("articles") || "[]");
        const id = new URLSearchParams(window.location.search).get("id");
        const storageKey = `progress_v1_${id}`; // 进度存储的 Key

        $.each(articles, function (index, item) {
          if (item.id == id) {
            $("#articleTitle").text(item.title);
            text_list = item.content
              .split(/[，。！：；？\n,.\!\?]/)
              .map((s) => s.trim())
              .filter((s) => s.length > 0);
            return false;
          }
        });

        // --- 进度存取逻辑 ---
        function loadSavedProgress() {
          const saved = localStorage.getItem(storageKey);
          if (saved !== null) {
            let index = parseInt(saved);
            // 如果进度已经到最后一句，重置为 0，否则载入进度
            currentIndex = index >= text_list.length - 1 ? 0 : index;
          }
        }

        function saveCurrentProgress() {
          if (id) {
            localStorage.setItem(storageKey, currentIndex);
          }
        }

        // --- 核心播放控制 ---
        function clearAll() {
          timers.forEach(clearTimeout);
          timers = [];
          $(".text").stop(true, true);
        }

        window.togglePlay = function () {
          isPlaying = !isPlaying;
          $("#playPauseBtn").text(isPlaying ? "⏸" : "▶️");
          if (isPlaying) {
            startReader();
          } else {
            clearAll();
          }
        };

        $(document).on("keydown", function (e) {
          if (e.code === "Space" || e.keyCode === 32) {
            e.preventDefault();
            togglePlay();
          }
        });

        function updateProgressUI(index) {
          const progress = (index / (text_list.length - 1)) * 100;
          $("#progressFill").css("width", progress + "%");
          saveCurrentProgress(); // 每次 UI 更新时同步保存进度
        }

        function startReader() {
          clearAll();
          if (currentIndex >= text_list.length) {
            currentIndex = 0; // 读完重置
          }
          if (!isPlaying) return;

          if (readerStyle === "typewriter") {
            showTypewriter();
          } else {
            showBreath();
          }
        }

        function showTypewriter() {
          if (!isPlaying) return;
          updateProgressUI(currentIndex);
          const text = text_list[currentIndex];
          const $area = $(".text").css("opacity", "1").html("");

          for (let i = 0; i <= text.length; i++) {
            timers.push(
              setTimeout(() => {
                $area.html(
                  text.substring(0, i) + '<span class="cursor">|</span>',
                );
                if (i === text.length) {
                  timers.push(
                    setTimeout(() => {
                      for (let j = text.length; j >= 0; j--) {
                        timers.push(
                          setTimeout(
                            () => {
                              $area.html(
                                text.substring(0, j) +
                                  '<span class="cursor">|</span>',
                              );
                              if (j === 0) {
                                timers.push(
                                  setTimeout(() => {
                                    currentIndex++;
                                    startReader();
                                  }, 500),
                                );
                              }
                            },
                            (text.length - j) * 50,
                          ),
                        );
                      }
                    }, 1000),
                  );
                }
              }, i * 100),
            );
          }
        }

        function showBreath() {
          if (!isPlaying) return;
          updateProgressUI(currentIndex);
          const $area = $(".text").text(text_list[currentIndex]);

          $area.fadeIn(1500, function () {
            timers.push(
              setTimeout(() => {
                $area.fadeOut(1500, function () {
                  currentIndex++;
                  startReader();
                });
              }, 1000),
            );
          });
        }

        // --- 进度条拖拽 ---
        function handleInteraction(e) {
          const rect = $("#progressBar")[0].getBoundingClientRect();
          const clickX = e.clientX - rect.left;
          const percentage = Math.max(
            0,
            Math.min(100, (clickX / rect.width) * 100),
          );
          currentIndex = Math.floor(
            (percentage / 100) * (text_list.length - 1),
          );

          updateProgressUI(currentIndex); // 包含保存进度逻辑
          $(".text")
            .stop(true, true)
            .css("opacity", "1")
            .show()
            .html(
              text_list[currentIndex] +
                (readerStyle === "typewriter"
                  ? '<span class="cursor">|</span>'
                  : ""),
            );
        }

        $("#progressBar").on("mousedown", function (e) {
          isDragging = true;
          clearAll();
          handleInteraction(e);
        });

        $(document).on("mousemove", function (e) {
          if (isDragging) handleInteraction(e);
        });

        $(document).on("mouseup", function () {
          if (isDragging) {
            isDragging = false;
            if (isPlaying) startReader();
          }
        });

        // --- UI 设置 ---
        let showTimeout;
        $(document).on("mousemove", function (e) {
          if (e.clientY <= 80 || e.clientY >= $(window).height() - 50) {
            $("#navbar, #progressBar").addClass("show");
            clearTimeout(showTimeout);
          } else {
            showTimeout = setTimeout(() => {
              if (!isDragging) $("#navbar, #progressBar").removeClass("show");
            }, 2000);
          }
        });

        window.showSettings = function () {
          clearAll();
          $("#settingsModal").fadeIn(200);
        };
        window.hideSettings = function () {
          $("#settingsModal").fadeOut(200);
          if (isPlaying) startReader();
        };

        window.changeReaderStyle = function () {
          readerStyle = $("#readerStyleSelect").val();
          localStorage.setItem("readerStyle", readerStyle);
        };

        window.changeFontSize = function () {
          const size = $("#fontSizeSlider").val();
          localStorage.setItem("fontSize", size);
          $("#fontSizeValue").text(size + "px");
          $(".text").css("font-size", size + "px");
        };

        // --- 初始化执行 ---
        loadSavedProgress(); // 1. 载入进度

        const savedSize = localStorage.getItem("fontSize") || "36";
        $("#fontSizeSlider").val(savedSize);
        $("#fontSizeValue").text(savedSize + "px");
        $(".text").css("font-size", savedSize + "px");
        $("#readerStyleSelect").val(readerStyle);

        startReader(); // 2. 开始播放
      });
    </script>
  </body>
</html>
