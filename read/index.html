<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>行读 - 沉浸式阅读器</title>
    <script src="https://lib.webstatic.cn/ajax/jquery/3.5.1/jquery.min.js"></script>
    <style>
      /* --- 基础样式 --- */
      .navbar {
        position: fixed;
        top: -60px;
        left: 0;
        right: 0;
        height: 60px;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        padding: 0 20px;
        transition: top 0.3s ease;
        z-index: 1000;
      }
      .navbar.show {
        top: 0;
      }
      .navbar a {
        color: #fff;
        text-decoration: none;
        padding: 8px 16px;
        border-radius: 4px;
        transition: background 0.2s;
      }
      .navbar a:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .controls-group {
        position: fixed;
        top: 20px;
        right: 20px;
        display: flex;
        gap: 10px;
        z-index: 1001;
      }
      .control-icon {
        width: 40px;
        height: 40px;
        background: rgba(0, 0, 0, 0.8);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        cursor: pointer;
        backdrop-filter: blur(10px);
        transition: 0.3s;
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .control-icon:hover {
        background: rgba(0, 0, 0, 0.9);
        transform: scale(1.1);
      }
      .cursor {
        animation: blink 1s infinite;
      }
      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0;
        }
      }

      /* --- 设置面板样式 --- */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
      }
      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(15, 15, 15, 0.95);
        padding: 25px;
        border-radius: 16px;
        width: 340px;
        color: #fff;
        border: 1px solid #444;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: flex;
        justify-content: space-between;
        margin-bottom: 8px;
        font-size: 14px;
        color: #bbb;
      }
      .form-group label span {
        color: #3498db;
        font-weight: bold;
      }
      .form-group select,
      .form-group input {
        width: 100%;
        padding: 8px;
        background: #333;
        color: #fff;
        border: 1px solid #555;
        border-radius: 6px;
      }
      input[type="range"] {
        height: 6px;
        -webkit-appearance: none;
        background: #444;
        border: none;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        background: #3498db;
        border-radius: 50%;
        cursor: pointer;
      }
      .form-buttons {
        display: flex;
        justify-content: flex-end;
        margin-top: 10px;
      }
      .btn {
        padding: 10px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        background: #3498db;
        color: white;
        font-weight: bold;
      }

      .progress-bar {
        position: fixed;
        bottom: -10px;
        left: 0;
        right: 0;
        height: 10px;
        background: rgba(255, 255, 255, 0.05);
        transition: bottom 0.3s ease;
        z-index: 1000;
        cursor: pointer;
      }
      .progress-bar.show {
        bottom: 0;
      }
      .progress-fill {
        height: 100%;
        background: #3498db;
        width: 0%;
        transition: width 0.1s linear;
      }
      .text {
        font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        transition: font-size 0.2s;
      }
      @media (max-width: 768px) {
        .text {
          font-size: 26px !important;
        }
      }
    </style>
  </head>
  <body
    style="
      height: 100vh;
      background: #000;
      color: #fff;
      margin: 0;
      overflow: hidden;
    "
  >
    <nav class="navbar" id="navbar">
      <a href="/">← 返回首页</a>
      <span
        id="articleTitle"
        style="flex: 1; text-align: center; font-weight: 500"
      ></span>
    </nav>

    <div class="controls-group">
      <div class="control-icon" id="playPauseBtn" onclick="togglePlay()">⏸</div>
      <div class="control-icon" onclick="showSettings()">⚙️</div>
    </div>

    <div class="progress-bar" id="progressBar">
      <div class="progress-fill" id="progressFill"></div>
    </div>

    <!-- 设置弹窗 -->
    <div class="modal" id="settingsModal">
      <div class="modal-content">
        <h3 style="margin-top: 0">阅读设置</h3>

        <div class="form-group">
          <label>模式</label>
          <select id="readerStyleSelect" onchange="updateSettings()">
            <option value="breath">呼吸模式</option>
            <option value="typewriter">打字机模式</option>
          </select>
        </div>

        <div class="form-group">
          <label>字号 <span id="fontSizeVal">36px</span></label>
          <input
            type="range"
            id="fontSizeSlider"
            min="20"
            max="80"
            value="36"
            oninput="updateSettings()"
          />
        </div>

        <div class="form-group">
          <label>显示速度 (快 → 慢) <span id="speedVal">100ms</span></label>
          <input
            type="range"
            id="speedSlider"
            min="20"
            max="500"
            step="10"
            value="100"
            oninput="updateSettings()"
          />
        </div>

        <div class="form-group">
          <label>句子停留时间 <span id="lingerVal">1.5s</span></label>
          <input
            type="range"
            id="lingerSlider"
            min="200"
            max="5000"
            step="100"
            value="1500"
            oninput="updateSettings()"
          />
        </div>

        <div class="form-buttons">
          <button class="btn" onclick="hideSettings()">确定</button>
        </div>
      </div>
    </div>

    <div
      style="
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        text-align: center;
        padding: 0 40px;
      "
    >
      <p class="text" style="line-height: 1.6; max-width: 900px; margin: 0"></p>
    </div>

    <script>
      $(document).ready(function () {
        let currentIndex = 0;
        let text_list = [];
        let isPlaying = true;
        let isDragging = false;
        let timers = [];

        // --- 响应式配置参数 ---
        let config = {
          style: localStorage.getItem("readerStyle") || "breath",
          fontSize: parseInt(localStorage.getItem("fontSize")) || 36,
          speed: parseInt(localStorage.getItem("readerSpeed")) || 100, // 字间距或淡入时长
          linger: parseInt(localStorage.getItem("readerLinger")) || 1500, // 停留时长
        };

        const id = new URLSearchParams(window.location.search).get("id");
        const storageKey = `progress_v1_${id}`;

        // 初始化数据
        const articles = JSON.parse(localStorage.getItem("articles") || "[]");
        $.each(articles, function (index, item) {
          if (item.id == id) {
            $("#articleTitle").text(item.title);
            text_list = item.content
              .split(/[，。！：；？\n,.\!\?]/)
              .map((s) => s.trim())
              .filter((s) => s.length > 0);
            return false;
          }
        });

        // 载入历史进度
        const savedProgress = localStorage.getItem(storageKey);
        if (savedProgress !== null) {
          currentIndex = parseInt(savedProgress);
          if (currentIndex >= text_list.length - 1) currentIndex = 0;
        }

        // --- 播放逻辑 ---
        function clearAll() {
          timers.forEach(clearTimeout);
          timers = [];
          $(".text").stop(true, true);
        }

        window.togglePlay = function () {
          isPlaying = !isPlaying;
          $("#playPauseBtn").text(isPlaying ? "⏸" : "▶️");
          if (isPlaying) startReader();
          else clearAll();
        };

        $(document).on("keydown", function (e) {
          if (e.code === "Space" || e.keyCode === 32) {
            e.preventDefault();
            togglePlay();
          }
        });

        function startReader() {
          clearAll();
          if (currentIndex >= text_list.length) currentIndex = 0;
          if (!isPlaying) return;

          const progress = (currentIndex / (text_list.length - 1)) * 100;
          $("#progressFill").css("width", progress + "%");
          localStorage.setItem(storageKey, currentIndex);

          if (config.style === "typewriter") showTypewriter();
          else showBreath();
        }

        function showTypewriter() {
          const text = text_list[currentIndex];
          const $area = $(".text").css("opacity", "1").html("");

          // 逐字输入速度取决于 config.speed
          for (let i = 0; i <= text.length; i++) {
            timers.push(
              setTimeout(() => {
                $area.html(
                  text.substring(0, i) + '<span class="cursor">|</span>',
                );

                if (i === text.length) {
                  // 停留时间取决于 config.linger
                  timers.push(
                    setTimeout(() => {
                      for (let j = text.length; j >= 0; j--) {
                        timers.push(
                          setTimeout(
                            () => {
                              $area.html(
                                text.substring(0, j) +
                                  '<span class="cursor">|</span>',
                              );
                              if (j === 0) {
                                timers.push(
                                  setTimeout(() => {
                                    currentIndex++;
                                    startReader();
                                  }, 300),
                                );
                              }
                            },
                            (text.length - j) * (config.speed / 2),
                          ),
                        ); // 删除速度通常比输入快一倍
                      }
                    }, config.linger),
                  );
                }
              }, i * config.speed),
            );
          }
        }

        function showBreath() {
          const $area = $(".text").text(text_list[currentIndex]).hide();
          // 淡入速度取决于 config.speed * 10 (缩放到毫秒级别)
          const fadeTime = config.speed * 10;

          $area.fadeIn(fadeTime, function () {
            timers.push(
              setTimeout(() => {
                $area.fadeOut(fadeTime, function () {
                  currentIndex++;
                  startReader();
                });
              }, config.linger),
            );
          });
        }

        // --- 设置管理 ---
        window.updateSettings = function () {
          config.style = $("#readerStyleSelect").val();
          config.fontSize = $("#fontSizeSlider").val();
          config.speed = parseInt($("#speedSlider").val());
          config.linger = parseInt($("#lingerSlider").val());

          // 更新UI显示
          $("#fontSizeVal").text(config.fontSize + "px");
          $("#speedVal").text(config.speed + "ms");
          $("#lingerVal").text((config.linger / 1000).toFixed(1) + "s");
          $(".text").css("font-size", config.fontSize + "px");

          // 持久化
          localStorage.setItem("readerStyle", config.style);
          localStorage.setItem("fontSize", config.fontSize);
          localStorage.setItem("readerSpeed", config.speed);
          localStorage.setItem("readerLinger", config.linger);
        };

        window.showSettings = function () {
          clearAll();
          // 初始化滑动条位置
          $("#readerStyleSelect").val(config.style);
          $("#fontSizeSlider").val(config.fontSize);
          $("#speedSlider").val(config.speed);
          $("#lingerSlider").val(config.linger);
          updateSettings();
          $("#settingsModal").fadeIn(200);
        };

        window.hideSettings = function () {
          $("#settingsModal").fadeOut(200);
          if (isPlaying) startReader();
        };

        // --- 进度条交互 ---
        function handleProgress(e) {
          const rect = $("#progressBar")[0].getBoundingClientRect();
          const percentage = Math.max(
            0,
            Math.min(100, ((e.clientX - rect.left) / rect.width) * 100),
          );
          currentIndex = Math.floor(
            (percentage / 100) * (text_list.length - 1),
          );
          $("#progressFill").css("width", percentage + "%");
          $(".text")
            .stop(true, true)
            .css("opacity", "1")
            .show()
            .html(
              text_list[currentIndex] +
                (config.style === "typewriter"
                  ? '<span class="cursor">|</span>'
                  : ""),
            );
        }

        $("#progressBar").on("mousedown", function (e) {
          isDragging = true;
          clearAll();
          handleProgress(e);
        });
        $(document).on("mousemove", function (e) {
          if (isDragging) handleProgress(e);
        });
        $(document).on("mouseup", function () {
          if (isDragging) {
            isDragging = false;
            if (isPlaying) startReader();
          }
        });

        // --- 自动显示控制 ---
        let showTimeout;
        $(document).on("mousemove", function (e) {
          if (e.clientY <= 80 || e.clientY >= $(window).height() - 50) {
            $("#navbar, #progressBar").addClass("show");
            clearTimeout(showTimeout);
          } else {
            showTimeout = setTimeout(() => {
              if (!isDragging && !$("#settingsModal").is(":visible")) {
                $("#navbar, #progressBar").removeClass("show");
              }
            }, 2000);
          }
        });

        // 初始化
        $(".text").css("font-size", config.fontSize + "px");
        startReader();
      });
    </script>
  </body>
</html>
